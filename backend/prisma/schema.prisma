// HaiTech CRM - Prisma Schema
// PostgreSQL database for managing coding education business

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================
// ENUMS
// ===================

enum UserRole {
  admin
  manager
  instructor
}

enum CourseCategory {
  programming
  ai
  robotics
  printing_3d @map("3d_printing")
}

enum BranchType {
  school
  community_center
  frontal
  online
}

enum OrderStatus {
  draft
  active
  completed
  cancelled
}

enum CycleType {
  private
  institutional_per_child
  institutional_fixed
}

enum CycleStatus {
  active
  completed
  cancelled
}

enum DayOfWeek {
  sunday
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
}

enum RegistrationStatus {
  registered
  active
  completed
  cancelled
  trial
}

enum PaymentStatus {
  unpaid
  partial
  paid
}

enum QuoteStatus {
  draft
  sent
  accepted
  rejected
  expired
  converted
}

enum QuoteClientType {
  private
  institutional
}

enum PaymentMethod {
  credit
  transfer
  cash
}

enum MeetingStatus {
  scheduled
  completed
  cancelled
  postponed
}

enum AttendanceStatus {
  present
  absent
  late
}

enum ActivityType {
  online
  frontal
  private_lesson @map("private")

  @@map("activity_type")
}

// ===================
// MODELS
// ===================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  phone        String?
  role         UserRole  @default(instructor)
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  instructor            Instructor?
  meetingUpdates        Meeting[]        @relation("MeetingStatusUpdater")
  attendanceRecords     Attendance[]
  savedViews            SavedView[]
  cycleExpenses         CycleExpense[]
  submittedExpenses     MeetingExpense[] @relation("ExpenseSubmitter")
  reviewedExpenses      MeetingExpense[] @relation("ExpenseReviewer")
  quotes                Quote[]

  @@map("users")
}

model Customer {
  id        String    @id @default(uuid())
  name      String
  email     String?   @unique
  phone     String    @unique
  address   String?
  city      String?
  notes     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  deletedBy String?   @map("deleted_by")

  // Relations
  students Student[]
  quotes   Quote[]

  @@map("customers")
}

model Student {
  id         String    @id @default(uuid())
  customerId String    @map("customer_id")
  name       String
  birthDate  DateTime? @map("birth_date") @db.Date
  grade      String?
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")
  deletedBy  String?   @map("deleted_by")

  // Relations
  customer      Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  registrations Registration[]
  attendance    Attendance[]

  @@map("students")
}

model Course {
  id             String         @id @default(uuid())
  name           String
  description    String?
  targetAudience String?        @map("target_audience")
  category       CourseCategory
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  cycles     Cycle[]
  quoteItems QuoteItem[]

  @@map("courses")
}

model Branch {
  id           String     @id @default(uuid())
  name         String
  type         BranchType
  address      String?
  city         String?
  contactName  String?    @map("contact_name")
  contactPhone String?    @map("contact_phone")
  contactEmail String?    @map("contact_email")
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  institutionalOrders InstitutionalOrder[]
  cycles              Cycle[]
  quotes              Quote[]

  @@map("branches")
}

model Instructor {
  id              String   @id @default(uuid())
  userId          String?  @unique @map("user_id")
  name            String
  phone           String   @unique
  email           String?
  rateFrontal     Decimal? @map("rate_frontal") @db.Decimal(10, 2)
  rateOnline      Decimal? @map("rate_online") @db.Decimal(10, 2)
  ratePrivate     Decimal? @map("rate_private") @db.Decimal(10, 2)
  ratePreparation Decimal? @map("rate_preparation") @db.Decimal(10, 2)
  employmentType  String   @default("freelancer") @map("employment_type")  // freelancer or employee
  isActive        Boolean  @default(true) @map("is_active")
  notes           String?
  inviteToken     String?  @unique @map("invite_token")
  inviteExpiresAt DateTime? @map("invite_expires_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  cycles          Cycle[]
  meetings        Meeting[]
  expenseRecords  MeetingExpense[]
  cycleExpenses   CycleExpense[]

  @@map("instructors")
}

model InstitutionalOrder {
  id                String      @id @default(uuid())
  branchId          String      @map("branch_id")
  orderNumber       String?     @map("order_number")
  orderDate         DateTime?   @map("order_date") @db.Date
  startDate         DateTime    @map("start_date") @db.Date
  endDate           DateTime    @map("end_date") @db.Date
  pricePerMeeting   Decimal     @map("price_per_meeting") @db.Decimal(10, 2)
  estimatedMeetings Int?        @map("estimated_meetings")
  estimatedTotal    Decimal?    @map("estimated_total") @db.Decimal(10, 2)
  contactName       String      @map("contact_name")
  contactPhone      String      @map("contact_phone")
  contactEmail      String?     @map("contact_email")
  contractFile      String?     @map("contract_file")
  status            OrderStatus @default(draft)
  notes             String?
  totalAmount       Decimal?    @map("total_amount") @db.Decimal(10, 2)
  invoiceNumber     String?     @map("invoice_number")
  invoiceLink       String?     @map("invoice_link")
  paymentStatus     PaymentStatus? @map("payment_status")
  paidAmount        Decimal?    @default(0) @map("paid_amount") @db.Decimal(10, 2)
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  branch Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  cycles Cycle[]
  quote  Quote?

  @@map("institutional_orders")
}

model Cycle {
  id                   String      @id @default(uuid())
  fireberryId          String?     @unique @map("fireberry_id")
  name                 String
  courseId             String      @map("course_id")
  branchId             String      @map("branch_id")
  instructorId         String      @map("instructor_id")
  institutionalOrderId String?     @map("institutional_order_id")
  type                 CycleType
  startDate            DateTime    @map("start_date") @db.Date
  endDate              DateTime    @map("end_date") @db.Date
  dayOfWeek            DayOfWeek   @map("day_of_week")
  startTime            DateTime    @map("start_time") @db.Time
  endTime              DateTime    @map("end_time") @db.Time
  durationMinutes      Int         @map("duration_minutes")
  totalMeetings        Int         @map("total_meetings")
  pricePerStudent      Decimal?    @map("price_per_student") @db.Decimal(10, 2)
  meetingRevenue       Decimal?    @map("meeting_revenue") @db.Decimal(10, 2)
  revenueIncludesVat   Boolean?    @map("revenue_includes_vat")
  studentCount         Int?        @map("student_count")
  maxStudents          Int?        @map("max_students")
  sendParentReminders  Boolean      @default(false) @map("send_parent_reminders")
  isOnline             Boolean      @default(false) @map("is_online")
  activityType         ActivityType @default(frontal) @map("activity_type")
  zoomHostId           String?      @map("zoom_host_id")
  zoomHostEmail        String?      @map("zoom_host_email")
  zoomMeetingId        String?      @map("zoom_meeting_id")
  zoomJoinUrl          String?      @map("zoom_join_url")
  zoomHostKey          String?      @map("zoom_host_key")
  zoomPassword         String?      @map("zoom_password")
  completedMeetings    Int         @default(0) @map("completed_meetings")
  remainingMeetings    Int         @default(0) @map("remaining_meetings")
  status               CycleStatus  @default(active)
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")
  deletedAt            DateTime?    @map("deleted_at")
  deletedBy            String?      @map("deleted_by")

  // Relations
  course             Course              @relation(fields: [courseId], references: [id], onDelete: Restrict)
  branch             Branch              @relation(fields: [branchId], references: [id], onDelete: Restrict)
  instructor         Instructor          @relation(fields: [instructorId], references: [id], onDelete: Restrict)
  institutionalOrder InstitutionalOrder? @relation(fields: [institutionalOrderId], references: [id], onDelete: SetNull)
  registrations      Registration[]
  meetings           Meeting[]
  expenses           CycleExpense[]

  @@map("cycles")
}

model Registration {
  id                 String              @id @default(uuid())
  studentId          String              @map("student_id")
  cycleId            String              @map("cycle_id")
  registrationDate   DateTime            @default(now()) @map("registration_date") @db.Date
  status             RegistrationStatus  @default(registered)
  amount             Decimal?            @db.Decimal(10, 2)
  paymentStatus      PaymentStatus?      @map("payment_status")
  paymentMethod      PaymentMethod?      @map("payment_method")
  invoiceLink        String?             @map("invoice_link")
  cancellationDate   DateTime?           @map("cancellation_date") @db.Date
  cancellationReason String?             @map("cancellation_reason")
  notes              String?
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  deletedAt          DateTime?           @map("deleted_at")
  deletedBy          String?             @map("deleted_by")

  // Relations
  student    Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  cycle      Cycle        @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  attendance Attendance[]

  @@unique([studentId, cycleId])
  @@map("registrations")
}

model Meeting {
  id                String        @id @default(uuid())
  cycleId           String        @map("cycle_id")
  instructorId      String        @map("instructor_id")
  scheduledDate     DateTime      @map("scheduled_date") @db.Date
  startTime         DateTime      @map("start_time") @db.Time
  endTime           DateTime      @map("end_time") @db.Time
  status            MeetingStatus @default(scheduled)
  statusUpdatedAt   DateTime?     @map("status_updated_at")
  statusUpdatedById String?       @map("status_updated_by")
  revenue           Decimal       @default(0) @db.Decimal(10, 2)
  instructorPayment Decimal       @default(0) @map("instructor_payment") @db.Decimal(10, 2)
  profit            Decimal       @default(0) @db.Decimal(10, 2)
  activityType      ActivityType? @map("activity_type")
  topic             String?
  notes             String?
  zoomMeetingId     String?       @map("zoom_meeting_id")
  zoomJoinUrl       String?       @map("zoom_join_url")
  zoomStartUrl      String?       @map("zoom_start_url")
  zoomPassword      String?       @map("zoom_password")
  zoomHostKey       String?       @map("zoom_host_key")
  zoomHostEmail     String?       @map("zoom_host_email")
  zoomRecordingUrl  String?       @map("zoom_recording_url")
  zoomRecordingPassword String?   @map("zoom_recording_password")
  lessonTranscript  String?       @map("lesson_transcript")
  lessonSummary     String?       @map("lesson_summary")
  rescheduledToId   String?       @map("rescheduled_to_id")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")
  deletedBy         String?       @map("deleted_by")

  // Relations
  cycle           Cycle            @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  instructor      Instructor       @relation(fields: [instructorId], references: [id], onDelete: Restrict)
  statusUpdatedBy User?            @relation("MeetingStatusUpdater", fields: [statusUpdatedById], references: [id])
  rescheduledTo   Meeting?         @relation("RescheduledMeetings", fields: [rescheduledToId], references: [id])
  rescheduledFrom Meeting[]        @relation("RescheduledMeetings")
  attendance      Attendance[]
  expenses        MeetingExpense[]

  @@map("meetings")
}

model Attendance {
  id             String           @id @default(uuid())
  meetingId      String           @map("meeting_id")
  registrationId String?          @map("registration_id")
  studentId      String?          @map("student_id")
  guestName      String?          @map("guest_name")
  status         AttendanceStatus
  isTrial        Boolean          @default(false) @map("is_trial")
  notes          String?
  recordedAt     DateTime         @default(now()) @map("recorded_at")
  recordedById   String?          @map("recorded_by")

  // Relations
  meeting      Meeting       @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  registration Registration? @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  student      Student?      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  recordedBy   User?         @relation(fields: [recordedById], references: [id])

  @@unique([meetingId, registrationId])
  @@unique([meetingId, studentId])
  @@map("attendance")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  userName  String?  @map("user_name")
  action    String   // CREATE, UPDATE, DELETE
  entity    String   // Customer, Cycle, Meeting, etc.
  entityId  String   @map("entity_id")
  oldValue  Json?    @map("old_value")
  newValue  Json?    @map("new_value")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SavedView {
  id          String   @id @default(uuid())
  name        String
  entity      String   // meetings, cycles, customers, students, courses, branches, instructors, registrations
  filters     Json     // Array of filter conditions
  columns     Json     // Array of column names to display
  sortBy      String?  @map("sort_by")
  sortOrder   String?  @map("sort_order") // asc, desc
  isDefault   Boolean  @default(false) @map("is_default")
  isPublic    Boolean  @default(false) @map("is_public") // Shared with all users
  createdById String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([entity])
  @@index([createdById])
  @@map("saved_views")
}

// ===================
// EXPENSE TRACKING
// ===================

enum CycleExpenseType {
  materials              // הכנת חומרים
  wraparound_hours       // שעות מעטפת
  equipment              // ציוד
  travel_fixed           // נסיעות קבועות
  additional_instructor  // מדריך נוסף
  other

  @@map("cycle_expense_type")
}

enum MeetingExpenseType {
  travel             // נסיעות
  taxi               // מונית
  extra_instructor   // מדריך נוסף
  materials          // חומרים
  other

  @@map("meeting_expense_type")
}

enum ExpenseStatus {
  pending            // ממתין לאישור
  approved           // מאושר
  rejected           // נדחה

  @@map("expense_status")
}

// Cycle-level expenses (spread across all meetings)
model CycleExpense {
  id            String           @id @default(dbgenerated("gen_random_uuid()::text"))
  cycleId       String           @map("cycle_id")
  type          CycleExpenseType
  description   String?
  amount        Decimal?         @db.Decimal(10, 2)
  isPercentage  Boolean          @default(false) @map("is_percentage")
  percentage    Decimal?         @db.Decimal(5, 2)
  hours         Decimal?         @db.Decimal(5, 2)
  rateType      String?          @map("rate_type")  // preparation, online, frontal
  createdById   String           @map("created_by")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @default(now()) @map("updated_at")
  
  // Optional: link to instructor for materials/wraparound_hours
  instructorId  String?          @map("instructor_id")

  // Relations
  cycle         Cycle            @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  createdBy     User             @relation(fields: [createdById], references: [id])
  instructor    Instructor?      @relation(fields: [instructorId], references: [id])

  @@index([cycleId])
  @@map("cycle_expenses")
}

// Meeting-level expenses (one-time, submitted by instructor)
model MeetingExpense {
  id              String             @id @default(dbgenerated("gen_random_uuid()::text"))
  meetingId       String             @map("meeting_id")
  type            MeetingExpenseType
  description     String?
  amount          Decimal            @db.Decimal(10, 2)
  status          ExpenseStatus      @default(approved)
  
  // Submitted by instructor
  submittedById   String             @map("submitted_by")
  submittedAt     DateTime           @default(now()) @map("submitted_at")
  
  // Approved/rejected by manager (kept for historical data)
  reviewedById    String?            @map("reviewed_by")
  reviewedAt      DateTime?          @map("reviewed_at")
  rejectionReason String?            @map("rejection_reason")
  
  // For extra_instructor type: link to instructor and rate calculation
  instructorId    String?            @map("instructor_id")
  rateType        String?            @map("rate_type")  // preparation, online, frontal
  hours           Decimal?           @db.Decimal(10, 2) @map("hours")

  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @default(now()) @map("updated_at")

  // Relations
  meeting         Meeting            @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  submittedBy     User               @relation("ExpenseSubmitter", fields: [submittedById], references: [id])
  reviewedBy      User?              @relation("ExpenseReviewer", fields: [reviewedById], references: [id])
  instructor      Instructor?        @relation(fields: [instructorId], references: [id])

  @@index([meetingId])
  @@index([status])
  @@index([submittedById])
  @@map("meeting_expenses")
}

// ===================
// QUOTES
// ===================

model Quote {
  id              String      @id @default(uuid())
  quoteNumber     String      @unique @map("quote_number")
  branchId        String?     @map("branch_id")
  institutionName String      @map("institution_name")
  contactName     String      @map("contact_name")
  contactPhone    String      @map("contact_phone")
  contactEmail    String?     @map("contact_email")
  contactRole     String?     @map("contact_role")
  clientType      QuoteClientType? @map("client_type")
  customerId      String?          @map("customer_id")
  
  // Paying body (גוף משלם)
  payingBodyName  String?          @map("paying_body_name")
  payingBodyPhone String?          @map("paying_body_phone")
  payingBodyEmail String?          @map("paying_body_email")
  payingBodyNotes String?          @map("paying_body_notes")
  content         Json?
  totalAmount     Decimal     @map("total_amount") @db.Decimal(10, 2)
  discount        Decimal?    @default(0) @db.Decimal(10, 2)
  finalAmount     Decimal     @map("final_amount") @db.Decimal(10, 2)
  validUntil      DateTime?   @map("valid_until") @db.Date
  status          QuoteStatus @default(draft)
  notes           String?
  orderId         String?     @unique @map("order_id")
  createdById     String      @map("created_by")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  branch    Branch?             @relation(fields: [branchId], references: [id])
  customer  Customer?           @relation(fields: [customerId], references: [id])
  items     QuoteItem[]
  order     InstitutionalOrder? @relation(fields: [orderId], references: [id])
  createdBy User                @relation(fields: [createdById], references: [id])

  @@map("quotes")
}

model QuoteItem {
  id              String  @id @default(uuid())
  quoteId         String  @map("quote_id")
  courseId         String? @map("course_id")
  courseName      String  @map("course_name")
  description     String?
  groups          Int
  meetingsPerGroup Int    @map("meetings_per_group")
  pricePerMeeting Decimal @map("price_per_meeting") @db.Decimal(10, 2)
  meetingDuration Int     @default(90) @map("meeting_duration")
  subtotal        Decimal @db.Decimal(10, 2)
  sortOrder       Int     @default(0) @map("sort_order")

  // Relations
  quote  Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  course Course? @relation(fields: [courseId], references: [id])

  @@map("quote_items")
}
