generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model api_keys {
  id           String    @id
  name         String
  key_hash     String    @unique
  key_prefix   String
  scopes       String[]  @default([])
  rate_limit   Int       @default(1000)
  is_active    Boolean   @default(true)
  expires_at   DateTime?
  last_used_at DateTime?
  last_used_ip String?
  created_by   String
  created_at   DateTime  @default(now())
  updated_at   DateTime

  @@index([is_active])
  @@index([key_prefix])
}

model attendance {
  id              String           @id
  meeting_id      String
  registration_id String?
  status          AttendanceStatus
  notes           String?
  recorded_at     DateTime         @default(now())
  recorded_by     String?
  student_id      String?
  guest_name      String?
  is_trial        Boolean          @default(false)
  meetings        meetings         @relation(fields: [meeting_id], references: [id], onDelete: Cascade)
  registrations   registrations?   @relation(fields: [registration_id], references: [id], onDelete: Cascade)

  @@unique([meeting_id, registration_id])
  @@unique([meeting_id, student_id])
}

model audit_logs {
  id         String   @id
  user_id    String?
  user_name  String?
  action     String
  entity     String
  entity_id  String
  old_value  Json?
  new_value  Json?
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())
  api_key_id String?

  @@index([api_key_id])
  @@index([created_at], map: "idx_audit_created")
  @@index([entity, entity_id], map: "idx_audit_entity")
  @@index([user_id], map: "idx_audit_user")
}

model branches {
  id                   String                 @id
  name                 String
  type                 BranchType
  address              String?
  city                 String?
  contact_name         String?
  contact_phone        String?
  contact_email        String?
  is_active            Boolean                @default(true)
  created_at           DateTime               @default(now())
  updated_at           DateTime
  cycles               cycles[]
  institutional_orders institutional_orders[]
}

model courses {
  id              String         @id
  name            String
  description     String?
  target_audience String?
  category        CourseCategory
  is_active       Boolean        @default(true)
  created_at      DateTime       @default(now())
  updated_at      DateTime
  cycles          cycles[]
}

model customers {
  id         String     @id
  name       String
  email      String?
  phone      String     @unique
  address    String?
  city       String?
  notes      String?
  created_at DateTime   @default(now())
  updated_at DateTime
  deleted_at DateTime?
  deleted_by String?
  students   students[]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model cycles {
  id                      String                @id
  name                    String
  course_id               String
  branch_id               String
  instructor_id           String
  institutional_order_id  String?
  type                    CycleType
  start_date              DateTime              @db.Date
  end_date                DateTime              @db.Date
  day_of_week             DayOfWeek
  start_time              DateTime              @db.Time(6)
  end_time                DateTime              @db.Time(6)
  duration_minutes        Int
  total_meetings          Int
  price_per_student       Decimal?              @db.Decimal(10, 2)
  max_students            Int?
  send_parent_reminders   Boolean               @default(false)
  is_online               Boolean               @default(false)
  zoom_host_id            String?
  completed_meetings      Int                   @default(0)
  remaining_meetings      Int                   @default(0)
  status                  CycleStatus           @default(active)
  created_at              DateTime              @default(now())
  updated_at              DateTime
  meeting_revenue         Decimal?              @db.Decimal(10, 2)
  student_count           Int?
  fireberry_id            String?               @unique
  activity_type           activity_type         @default(frontal)
  deleted_at              DateTime?
  deleted_by              String?
  zoom_meeting_id         String?
  zoom_join_url           String?
  zoom_host_key           String?
  zoom_password           String?
  zoom_host_email         String?
  primary_instructor_id   String?
  instructor_total_budget Decimal?              @db.Decimal(10, 2)
  branches                branches              @relation(fields: [branch_id], references: [id])
  courses                 courses               @relation(fields: [course_id], references: [id])
  institutional_orders    institutional_orders? @relation(fields: [institutional_order_id], references: [id])
  instructors             instructors           @relation(fields: [instructor_id], references: [id])
  meetings                meetings[]
  registrations           registrations[]
}

model institutional_orders {
  id                 String      @id
  branch_id          String
  order_number       String?
  order_date         DateTime?   @db.Date
  start_date         DateTime    @db.Date
  end_date           DateTime    @db.Date
  price_per_meeting  Decimal     @db.Decimal(10, 2)
  estimated_meetings Int?
  estimated_total    Decimal?    @db.Decimal(10, 2)
  contact_name       String
  contact_phone      String
  contact_email      String?
  contract_file      String?
  status             OrderStatus @default(draft)
  notes              String?
  created_at         DateTime    @default(now())
  updated_at         DateTime
  cycles             cycles[]
  branches           branches    @relation(fields: [branch_id], references: [id], onDelete: Cascade)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model instructors {
  id                String     @id
  user_id           String?    @unique
  name              String
  phone             String     @unique
  email             String?
  rate_frontal      Decimal?   @db.Decimal(10, 2)
  rate_online       Decimal?   @db.Decimal(10, 2)
  rate_preparation  Decimal?   @db.Decimal(10, 2)
  is_active         Boolean    @default(true)
  notes             String?
  created_at        DateTime   @default(now())
  updated_at        DateTime
  invite_token      String?    @unique
  invite_expires_at DateTime?
  rate_private      Decimal?   @db.Decimal(10, 2)
  rate_support      Decimal?   @db.Decimal(10, 2)
  cycles            cycles[]
  users             users?     @relation(fields: [user_id], references: [id])
  meetings          meetings[]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model meetings {
  id                      String           @id
  cycle_id                String
  instructor_id           String
  scheduled_date          DateTime         @db.Date
  start_time              DateTime         @db.Time(6)
  end_time                DateTime         @db.Time(6)
  status                  MeetingStatus    @default(scheduled)
  status_updated_at       DateTime?
  status_updated_by       String?
  revenue                 Decimal          @default(0) @db.Decimal(10, 2)
  instructor_payment      Decimal          @default(0) @db.Decimal(10, 2)
  profit                  Decimal          @default(0) @db.Decimal(10, 2)
  topic                   String?
  notes                   String?
  zoom_meeting_id         String?
  zoom_join_url           String?
  zoom_start_url          String?
  rescheduled_to_id       String?
  created_at              DateTime         @default(now())
  updated_at              DateTime
  activity_type           activity_type?
  deleted_at              DateTime?
  deleted_by              String?
  zoom_password           String?
  zoom_host_key           String?
  zoom_host_email         String?
  zoom_recording_url      String?
  zoom_recording_password String?
  lesson_transcript       String?
  lesson_summary          String?
  instructor_role         instructor_role?
  attendance              attendance[]
  cycles                  cycles           @relation(fields: [cycle_id], references: [id], onDelete: Cascade)
  instructors             instructors      @relation(fields: [instructor_id], references: [id])
  meetings                meetings?        @relation("meetingsTomeetings", fields: [rescheduled_to_id], references: [id])
  other_meetings          meetings[]       @relation("meetingsTomeetings")
  users                   users?           @relation(fields: [status_updated_by], references: [id])
}

model registrations {
  id                  String             @id
  student_id          String
  cycle_id            String
  registration_date   DateTime           @default(now()) @db.Date
  status              RegistrationStatus @default(registered)
  amount              Decimal?           @db.Decimal(10, 2)
  payment_status      PaymentStatus?
  payment_method      PaymentMethod?
  invoice_link        String?
  cancellation_date   DateTime?          @db.Date
  cancellation_reason String?
  notes               String?
  created_at          DateTime           @default(now())
  updated_at          DateTime
  deleted_at          DateTime?
  deleted_by          String?
  attendance          attendance[]
  cycles              cycles             @relation(fields: [cycle_id], references: [id], onDelete: Cascade)
  students            students           @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([student_id, cycle_id])
}

model saved_views {
  id         String   @id
  name       String
  entity     String
  filters    Json
  columns    Json
  sort_by    String?
  sort_order String?
  is_default Boolean  @default(false)
  is_public  Boolean  @default(false)
  created_by String
  created_at DateTime @default(now())
  updated_at DateTime

  @@index([created_by], map: "idx_saved_views_created_by")
  @@index([entity], map: "idx_saved_views_entity")
}

model students {
  id            String          @id
  customer_id   String
  name          String
  birth_date    DateTime?       @db.Date
  grade         String?
  notes         String?
  created_at    DateTime        @default(now())
  updated_at    DateTime
  deleted_at    DateTime?
  deleted_by    String?
  age           Int?
  registrations registrations[]
  customers     customers       @relation(fields: [customer_id], references: [id], onDelete: Cascade)
}

model users {
  id            String       @id
  email         String       @unique
  password_hash String
  name          String
  phone         String?
  role          UserRole     @default(instructor)
  is_active     Boolean      @default(true)
  last_login    DateTime?
  created_at    DateTime     @default(now())
  updated_at    DateTime
  instructors   instructors?
  meetings      meetings[]
  webhooks      webhooks[]
}

model webhook_deliveries {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  webhook_id    String
  event         String    @db.VarChar(100)
  payload       Json
  response_code Int?
  response_body String?
  success       Boolean?  @default(false)
  attempts      Int?      @default(1)
  next_retry_at DateTime? @db.Timestamp(6)
  completed_at  DateTime? @db.Timestamp(6)
  error         String?
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  webhooks      webhooks  @relation(fields: [webhook_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([event])
  @@index([next_retry_at])
  @@index([success])
  @@index([webhook_id])
}

model webhooks {
  id                 String               @id @default(dbgenerated("(gen_random_uuid())::text"))
  name               String               @db.VarChar(255)
  url                String
  events             String[]             @default([])
  secret             String?
  headers            Json?
  status             String?              @default("active") @db.VarChar(20)
  created_by         String
  created_at         DateTime?            @default(now()) @db.Timestamp(6)
  updated_at         DateTime?            @default(now()) @db.Timestamp(6)
  webhook_deliveries webhook_deliveries[]
  users              users                @relation(fields: [created_by], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([status])
}

enum AttendanceStatus {
  present
  absent
  late
}

enum BranchType {
  school
  community_center
  frontal
  online
}

enum CourseCategory {
  programming
  ai
  robotics
  d_printing  @map("3d_printing")
}

enum CycleStatus {
  active
  completed
  cancelled
}

enum CycleType {
  private
  institutional_per_child
  institutional_fixed
}

enum DayOfWeek {
  sunday
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
}

enum MeetingStatus {
  scheduled
  completed
  cancelled
  postponed
}

enum OrderStatus {
  draft
  active
  completed
  cancelled
}

enum PaymentMethod {
  credit
  transfer
  cash
}

enum PaymentStatus {
  unpaid
  partial
  paid
}

enum RegistrationStatus {
  registered
  active
  completed
  cancelled
  trial
}

enum UserRole {
  admin
  manager
  instructor
}

enum activity_type {
  online
  frontal
  private
}

enum instructor_role {
  primary
  support
}
